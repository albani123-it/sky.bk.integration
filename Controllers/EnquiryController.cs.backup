using idc.bk.integration.Libs;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using System;
using System.IO;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;
using System.Xml;
using System.Xml.Linq;
using ICSharpCode.SharpZipLib.Zip;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;

// For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860

namespace idc.bk.integration.Controllers
{
    [Authorize(AuthenticationSchemes = JwtBearerDefaults.AuthenticationScheme)]
    [Route("idcbkintegration/[controller]")]
    public class EnquiryController : Controller
    {
        private lDbConn dbconn = new lDbConn();
        private lConvert lc = new lConvert();
        private BaseController bc = new BaseController();
        private TokenController tc = new TokenController();
        private PinvokeWindowsNetworking abc = new PinvokeWindowsNetworking();
        private string prefix_req = "req_";
        private string prefix_res = "res_";
        private string prefix_smr = "smr_";
        private string prefix_cus = "cus_";
        private MessageController mc = new MessageController();


        #region proses untuk company

        [HttpPost("EnquiryBK")]
        public JObject ProcessToServerCompanyBK([FromBody]JObject json)
        {
            var filename = "";
            string allText = "";
            var resdate = "";
            var folder = "";
            var path = "";
            var reqname = "";
            string strXmlData = "";

            using (StreamReader sr = new StreamReader("file/headerconfig.json"))
            {
                allText = sr.ReadToEnd();
            }
            var joHeader = JObject.Parse(allText);

            #region process generate request & send request to webservice pefindo
            //  process generate request & send request to webservice pefindo ==> save response to xml file 
            //generate request
            var joReqData = GenerateReqData(json);
            filename = joReqData.GetValue("filename").ToString();


            // send request to web service pefindo 
            filename = joReqData.GetValue("filename").ToString();
            folder = Path.GetFullPath("file/request/");
            path = folder + prefix_req + prefix_smr + filename + joHeader.GetValue("ext").ToString();

            strXmlData = "";
            using (StreamReader sr = new StreamReader(path))
            {
                strXmlData = sr.ReadToEnd();
            }

            var mkFolder = Path.GetFullPath("file/response/");
            XmlDocument reqdocx = new XmlDocument();
            reqdocx.Load(new StringReader(strXmlData));
            var soapaction = "soap_action_smr_company";
            //var josmr_company = PostDataXml(reqdocx, soapaction);
            var josmr_company = new JObject();
            reqname = "73.093.155.7-503.000_20190902111408";
            filename = reqname;
            folder = Path.GetFullPath("file/response/");
            path = folder + prefix_res + prefix_smr + filename + joHeader.GetValue("ext").ToString();

            strXmlData = "";
            using (StreamReader sr = new StreamReader(path))
            {
                strXmlData = sr.ReadToEnd();
            }

            mkFolder = Path.GetFullPath("file/response/");

            var dataDummy1 = new JObject();
            dataDummy1.Add("status", mc.GetMessage("api_output_ok"));
            dataDummy1.Add("response", strXmlData);

            josmr_company = dataDummy1;

            var jocus_company = new JObject();
            var strRes_smr_company = "";
            if (josmr_company.GetValue("status").ToString() == mc.GetMessage("api_output_ok"))
            {
                strRes_smr_company = josmr_company.GetValue("response").ToString();

                string xmlresponse = "";
                XmlDocument resdocx_smr_company = new XmlDocument();
                resdocx_smr_company.Load(new StringReader(strRes_smr_company));

                var josmr_company_xml = JsonConvert.SerializeXmlNode(resdocx_smr_company);
                var joReqcustRpt = JObject.Parse(josmr_company_xml);
                joReqcustRpt.Add("subject_type", json.GetValue("type_data").ToString());
                joReqcustRpt.Add("npwp", json.GetValue("npwp").ToString());
                var joGenReqCustonRpt = GenerateReqCustomReport(joReqcustRpt);

                filename = joGenReqCustonRpt.GetValue("filename").ToString();
                folder = Path.GetFullPath("file/request/");
                path = folder + prefix_req + prefix_cus + filename + joHeader.GetValue("ext").ToString();

                strXmlData = "";
                using (StreamReader sr = new StreamReader(path))
                {
                    strXmlData = sr.ReadToEnd();
                }

                folder = Path.GetFullPath("file/request/");
                XmlDocument reqdocx_cusrpt = new XmlDocument();
                reqdocx_cusrpt.Load(new StringReader(strXmlData));

                //soapaction = "soap_action_cus_company";
                //jocus_company = PostDataXml(reqdocx_cusrpt, soapaction);

                if (jocus_company.GetValue("status").ToString()== mc.GetMessage("api_output_ok"))
                {
                    var strRes_cus_company = jocus_company.GetValue("response").ToString();
                    XmlDocument resdocx_cus_company = new XmlDocument();
                    resdocx_cus_company.Load(new StringReader(strRes_cus_company));
                    //save response custom report
                    folder = Path.GetFullPath("file/response/");
                    path = folder + prefix_res + prefix_cus + filename + joHeader.GetValue("ext").ToString();
                    resdocx_cus_company.Save(path);
                }
            }

            // end
            #endregion

            #region proses setelah dapat response dari biro kredit

            resdate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            // proses konvert xml ke json
            folder = Path.GetFullPath("file/response/");

            //untuk testing filename disetup sebagai ='testingxmldata'
            //filename = "testingxmldata";            

            path = folder + prefix_res + prefix_cus + filename + joHeader.GetValue("ext").ToString();

            strXmlData = "";
            using (StreamReader sr = new StreamReader(path))
            {
                strXmlData = sr.ReadToEnd();
            }

            XmlDocument docx = new XmlDocument();
            docx.Load(new StringReader(strXmlData));
            var joXml = JsonConvert.SerializeXmlNode(docx);
            mkFolder = Path.GetFullPath("file/response/" + prefix_res + prefix_cus + filename + ".json");
            FileInfo fi = new FileInfo(mkFolder);

            //check 1st check file jika sudah ada di delete dan generate baru
            if (fi.Exists)
            {
                fi.Delete();
            }

            // Create a new file     
            using (FileStream fs = fi.Create())
            {
                Byte[] txt = new UTF8Encoding(true).GetBytes("New file.");
                fs.Write(txt, 0, txt.Length);
                Byte[] author = new UTF8Encoding(true).GetBytes("idxteam");
                fs.Write(author, 0, author.Length);
            }
            System.IO.File.WriteAllText(mkFolder, joXml);

            var joDataXml1 = new JObject();
            joDataXml1 = JObject.Parse(joXml.ToString());
            // end
            #endregion

            var data = new JObject();
            data.Add("status", mc.GetMessage("process_success"));
            //data.Add("reqdate", joReqData.GetValue("reqdate").ToString());
            data.Add("resdate", resdate);
            data.Add("filename", filename);
            data.Add("data", joDataXml1);
            data.Add("response", strRes_smr_company);

            return data;
        }

        public JObject GenerateReqData(JObject json)
        {
            var data = new JObject();
            var joRtnInfo = new JObject();
            var today = DateTime.Now.ToString("yyyyMMddHHmmss");
            var reqdate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            string allText = "";

            using (StreamReader sr = new StreamReader("file/headerconfig.json"))
            {
                allText = sr.ReadToEnd();
            }
            var joHeader = JObject.Parse(allText);
            var joData = json;
            var doc = new XmlDocument();

            #region generate req xml
            XNamespace soapenv = "http://schemas.xmlsoap.org/soap/envelope/";
            XNamespace cb5 = "http://creditinfo.com/CB5";
            XNamespace smar = "http://creditinfo.com/CB5/v5.53/SmartSearch";

            XElement root = new XElement(soapenv + "Envelope", new XAttribute(XNamespace.Xmlns + "soapenv", soapenv.NamespaceName),
                new XAttribute(XNamespace.Xmlns + "cb5", cb5.NamespaceName),
                new XAttribute(XNamespace.Xmlns + "smar", smar.NamespaceName),
                new XElement(soapenv + "Header"),
                new XElement(soapenv + "Body",
                             new XElement(cb5 + "SmartSearchCompany",
                                          new XElement(cb5 + "query",
                                                       new XElement(smar + "InquiryReason", joHeader.GetValue("InquiryReason").ToString()),
                                                       new XElement(smar + "InquiryReasonText", joHeader.GetValue("InquiryReason").ToString()),
                                                       new XElement(smar + "Parameters",
                                                                    new XElement(smar + "CompanyName", json.GetValue("company_name").ToString()),
                                                                    new XElement(smar + "IdNumbers",
                                                                                 new XElement(smar + "IdNumberPairCompany",
                                                                                              new XElement(smar + "IdNumber", json.GetValue("npwp").ToString()),
                                                                                              new XElement(smar + "IdNumberType", "NPWP")
                                                                                              )
                                                                                 )

                                                                     )
                                                       )
                                           )
                             )
                );
            #endregion 

            var filename = "";
            var folder = Path.GetFullPath("file/request/");

            filename = joData.GetValue("npwp").ToString() + "_" + today;
            var path = folder + prefix_req + prefix_smr + filename + joHeader.GetValue("ext").ToString();

            root.Save(path);

            data.Add("filename", filename);
            data.Add("reqdate", reqdate);

            return data;
        }

        public JObject GenerateReqCustomReport(JObject json)
        {
            var jo1 = JObject.Parse(json.GetValue("s:Envelope").ToString());
            var jo2 = JObject.Parse(jo1.GetValue("s:Body").ToString());
            var jo3 = JObject.Parse(jo2.GetValue("SmartSearchCompanyResponse").ToString());
            var jo4 = JObject.Parse(jo3.GetValue("SmartSearchCompanyResult").ToString());

            var data = new JObject();
            var joRtnInfo = new JObject();
            var today = DateTime.Now.ToString("yyyyMMddHHmmss");
            var reqdate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            var reqdate_cusrpt = DateTime.Now.ToString("yyyy-MM-dd");
            string allText = "";

            using (StreamReader sr = new StreamReader("file/headerconfig.json"))
            {
                allText = sr.ReadToEnd();
            }
            var joHeader = JObject.Parse(allText);
            var joData = json;
            var doc = new XmlDocument();

            #region generate req xml
            XNamespace soapenv = "http://schemas.xmlsoap.org/soap/envelope/";
            XNamespace cb5 = "http://creditinfo.com/CB5";
            XNamespace cus = "http://creditinfo.com/CB5/v5.53/CustomReport";
            XNamespace arr = "http://schemas.microsoft.com/2003/10/Serialization/Arrays";

            XElement root = new XElement(soapenv + "Envelope", new XAttribute(XNamespace.Xmlns + "soapenv", soapenv.NamespaceName),
                new XAttribute(XNamespace.Xmlns + "cb5", cb5.NamespaceName),
                new XAttribute(XNamespace.Xmlns + "cus", cus.NamespaceName),
                new XAttribute(XNamespace.Xmlns + "arr", arr.NamespaceName),
                new XElement(soapenv + "Header"),
                new XElement(soapenv + "Body",
                             new XElement(cb5 + "GetCustomReport",
                                          new XElement(cb5 + "parameters",
                                                       new XElement(cus + "Consent", Convert.ToBoolean(joHeader.GetValue("Consent").ToString())),
                                                       new XElement(cus + "IDNumber", jo4.GetValue("a:PefindoId").ToString()),
                                                       new XElement(cus + "IDNumberType", joHeader.GetValue("IDNumberType").ToString()),
                                                       new XElement(cus + "InquiryReason", joHeader.GetValue("InquiryReason").ToString()),
                                                       new XElement(cus + "InquiryReasonText"), 
                                                       new XElement(cus + "ReportDate", reqdate_cusrpt),
                                                       new XElement(cus + "Sections",
                                                                    new XElement(arr + "string", joHeader.GetValue("Sections").ToString())
                                                                    ),
                                                       new XElement(cus + "SubjectType", joData.GetValue("subject_type").ToString())
                                                     )
                                        )
                              )
                           
                        );
            #endregion 

            var filename_custrpt = "";
            var folder = Path.GetFullPath("file/request/");

            filename_custrpt = joData.GetValue("npwp").ToString() + "_" + today;
            var path = folder + prefix_req + prefix_cus + filename_custrpt + joHeader.GetValue("ext").ToString();

            root.Save(path);

            data.Add("filename", filename_custrpt);
            data.Add("reqdate", reqdate);

            return data;
        }


        #endregion

        #region proses untuk personal
        [HttpPost("EnquiryPersonalBK")]
        public JObject ProcessToServerPersonalBK([FromBody]JObject json)
        {
            var filename = "";
            var filenamecust = "";
            var pefindoid = "";
            var filename_otherdata = "";
            string allText = "";
            var resdate = "";
            var folder = "";
            var path = "";
            var address = "";
            var dob1 = "";
            var fullname = "";
            var ktp = "";
            var collectdataarray = "";
            var count_pefid = "";
            string strXmlData = "";
            var data = new JObject();
            var joReturn = new JObject();
            try
            {
                Random r = new Random();
                var requestid = DateTime.Now.ToString("yyyyMMddHHMMssffffff").ToString() + r.Next().ToString();

                using (StreamReader sr = new StreamReader("file/headerconfig.json"))
                {
                    allText = sr.ReadToEnd();
                }
                var joHeader = JObject.Parse(allText);

                #region proses request smartsearch
                //  process generate request & send request to webservice pefindo ==> save response to xml file 
                //generate request
                var joReqData = GenerateReqPersonalData(json, requestid);
                filename = joReqData.GetValue("filename").ToString();

                // send request to web service pefindo 
                //var reqname = "_20190902111408";
                //reqname = json.GetValue("ktp").ToString() + reqname;
                //filename = joReqData.GetValue("filename").ToString();
                //filename = reqname;


                //folder = Path.GetFullPath("file/request/");
                folder = Path.GetFullPath("file/request/smrserch/");
                path = folder + prefix_req + prefix_smr + filename + joHeader.GetValue("ext").ToString();

                strXmlData = "";
                using (StreamReader sr = new StreamReader(path))
                {
                    strXmlData = sr.ReadToEnd();
                }

                //var mkFolder = Path.GetFullPath("file/response/");
                var mkFolder = Path.GetFullPath("file/response/smrserch/");
                XmlDocument reqdocx = new XmlDocument();
                reqdocx.Load(new StringReader(strXmlData));
                var soapaction = "soap_action_smr_personal";
                var josmr_personal = new JObject();

                ////// start remark untuk proses 1 dummy data dan unremark untuk direct langsung ke pefindo webservice
                //josmr_personal = PostDataXml(reqdocx, soapaction);
                //josmr_personal = PostDataXmlnotsoap(strXmlData);
                //////end

                //start proses 1 ini hanya untuk sebelum ada koneksi ke pefindo webservice dan unremark jika direct langsung ke pefindo webservice
                var reqname = joHeader.GetValue("dummy_smr").ToString();
                filename = reqname;
                folder = Path.GetFullPath("file/response/smrserch/");
                path = folder + prefix_res + prefix_smr + filename + joHeader.GetValue("ext").ToString();

                strXmlData = "";
                using (StreamReader sr = new StreamReader(path))
                {
                    strXmlData = sr.ReadToEnd();
                }

                mkFolder = Path.GetFullPath("file/response/smrserch/");
                var dataDummy1 = new JObject();
                dataDummy1.Add("status", mc.GetMessage("api_output_ok"));
                dataDummy1.Add("response", strXmlData);
                josmr_personal = dataDummy1;
                //end
                #endregion

                #region proses response smartsearch
                var jocus_personal = new JObject();
                var strRes_smr_company = "";
                if (josmr_personal.GetValue("status").ToString() == mc.GetMessage("api_output_ok"))
                {
                    strRes_smr_company = josmr_personal.GetValue("response").ToString();
                    string xmlresponse = "";
                    XmlDocument resdocx_smr_company = new XmlDocument();
                    resdocx_smr_company.Load(new StringReader(strRes_smr_company));

                    folder = Path.GetFullPath("file/response/smrserch/");
                    path = folder + prefix_res + prefix_smr + filename + joHeader.GetValue("ext").ToString();
                    resdocx_smr_company.Save(path);

                    var josmr_company_xml = JsonConvert.SerializeXmlNode(resdocx_smr_company);
                    var joReqcustRpt = JObject.Parse(josmr_company_xml);
                    joReqcustRpt.Add("subject_type", json.GetValue("type_data").ToString());
                    joReqcustRpt.Add("ktp", json.GetValue("ktp").ToString());

                    var jo1 = JObject.Parse(joReqcustRpt.GetValue("ns0:ServiceEnvelope").ToString());
                    var jo2 = JObject.Parse(jo1.GetValue("ns1:ServiceBody").ToString());
                    var jo3 = JObject.Parse(jo2.GetValue("ns2:pfSmartSearchIndividualRs").ToString());
                    var jo4 = JObject.Parse(jo3.GetValue("ns2:SmartSearchIndividualResult").ToString());

                    var jo5 = JObject.Parse(jo4.GetValue("ns2:IndividualRecords").ToString());
                    var indivrecored = jo5.GetValue("ns2:SearchIndividualRecord").ToString();
                    var checkTypeObj = CheckDataObject(indivrecored);
                    if (checkTypeObj.GetValue("object_type").ToString() == "JObject")
                    {
                        var jo6 = JObject.Parse(jo5.GetValue("ns2:SearchIndividualRecord").ToString());
                        pefindoid = jo6.GetValue("ns2:PefindoId").ToString();
                        if (pefindoid == "{\r\n  \"@nil\": \"true\"\r\n}")
                        {
                            pefindoid = "";
                        }
                        else
                        {
                            pefindoid = jo6.GetValue("ns2:PefindoId").ToString();
                            count_pefid = "1";
                        }

                    }
                    else if (checkTypeObj.GetValue("object_type").ToString() == "JArray")
                    {
                        var jaData = JArray.Parse(jo5.GetValue("ns2:SearchIndividualRecord").ToString());
                        if (jaData[0]["ns2:PefindoId"].ToString() != "")
                        {
                            for (int a = 0; a < jaData.Count; a++)
                            {
                                address = jaData[a]["ns2:Address"].ToString();
                                if (address == "{\r\n  \"@nil\": \"true\"\r\n}")
                                {
                                    address = "";
                                }
                                else
                                {
                                    address = jaData[a]["ns2:Address"].ToString();
                                }

                                dob1 = jaData[a]["ns2:DateOfBirth"].ToString();
                                if (dob1 == "{\r\n  \"@nil\": \"true\"\r\n}")
                                {
                                    dob1 = "";
                                }
                                else
                                {
                                    dob1 = Convert.ToDateTime(jaData[a]["ns2:DateOfBirth"]).ToString("yyyy-MM-dd");
                                }

                                fullname = jaData[a]["ns2:FullName"].ToString();
                                if (fullname == "{\r\n  \"@nil\": \"true\"\r\n}")
                                {
                                    fullname = "";
                                }
                                else
                                {
                                    fullname = jaData[a]["ns2:FullName"].ToString();
                                }

                                ktp = jaData[a]["ns2:KTP"].ToString();
                                if (ktp == "{\r\n  \"@nil\": \"true\"\r\n}")
                                {
                                    ktp = "";
                                }
                                else
                                {
                                    ktp = jaData[a]["ns2:KTP"].ToString();
                                }

                                joReturn = this.chkjarowinkler(ktp, fullname, dob1, address, json.GetValue("ttable").ToString());
                                collectdataarray += joReturn.GetValue("retrundata").ToString() + "|";
                            }

                            collectdataarray = collectdataarray.TrimEnd('|');

                            //var threshold = dbconn.GetCredential("threshold");
                            int count = 0;
                            bool checkthreshold = false;
                            float[] arr = collectdataarray.Split('|').Select(float.Parse).ToArray();
                            float max;
                            var responethreshold = float.Parse(dbconn.GetCredential("threshold").ToString(), CultureInfo.InvariantCulture.NumberFormat);
                            //check jika tidak ada <= threshold 
                            for (int x = 0; x < arr.Count(); x++)
                            {
                                if (arr[x] >= responethreshold)
                                {
                                    checkthreshold = true;
                                    break;
                                }

                            }
                            //end
                            if (checkthreshold == true)
                            {
                                // check counter
                                // size of the array
                                for (int x = 0; x < arr.Count(); x++)
                                {
                                    if (arr[x] >= responethreshold)
                                    {
                                        count++;
                                    }
                                }

                                count_pefid = count.ToString();
                                //count_pefid = arr.Count().ToString();
                                // end
                                max = arr[0];
                                pefindoid = jaData[0]["ns2:PefindoId"].ToString();
                                for (int i = 1; i < arr.Count(); i++)
                                {
                                    if (arr[i] > max)
                                    {
                                        pefindoid = jaData[i]["ns2:PefindoId"].ToString();
                                        max = arr[i];
                                    }

                                }
                            }
                            else
                            {
                                this.updatecounterpefid(json.GetValue("ttable").ToString());
                                var jo11 = JObject.Parse(joReqcustRpt.GetValue("ns0:ServiceEnvelope").ToString());
                                var jo12 = JObject.Parse(jo11.GetValue("ns1:PefindoId").ToString());
                            }

                        }
                        else
                        {
                            pefindoid = null;
                        }
                    } //jarray close
                    #endregion

                    #region proses request customrpt ke pefindo
                    var joGenReqCustonRpt = GenerateReqPersonalCustomReport(joReqcustRpt, pefindoid, requestid);
                    filenamecust = joGenReqCustonRpt.GetValue("filename").ToString();

                    //folder = Path.GetFullPath("file/request/");
                    folder = Path.GetFullPath("file/request/custrpt/");
                    path = folder + prefix_req + prefix_cus + filenamecust + joHeader.GetValue("ext").ToString();

                    strXmlData = "";
                    using (StreamReader sr = new StreamReader(path))
                    {
                        strXmlData = sr.ReadToEnd();
                    }

                    //folder = Path.GetFullPath("file/request/");
                    folder = Path.GetFullPath("file/request/custrpt/");
                    XmlDocument reqdocx_cusrpt = new XmlDocument();
                    reqdocx_cusrpt.Load(new StringReader(strXmlData));

                    //// start remark untuk proses 2 dummy data dan unremark jika direct langnsung ke pefindo webservice
                    //jocus_personal = PostDataXml(reqdocx_cusrpt, soapaction);
                    //jocus_personal = PostDataXmlnotsoap(strXmlData);
                    ////end

                    //  start proses 2 ini jika pakai dumm dan remark jika pakai dummy data
                    reqname = joHeader.GetValue("dummy_cus").ToString();
                    //reqname = json.GetValue("ktp").ToString() + reqname;
                    filenamecust = reqname;
                    //folder = Path.GetFullPath("file/response/");
                    folder = Path.GetFullPath("file/response/custrpt/");
                    path = folder + prefix_res + prefix_cus + filenamecust + joHeader.GetValue("ext").ToString();

                    strXmlData = "";
                    using (StreamReader sr = new StreamReader(path))
                    {
                        strXmlData = sr.ReadToEnd();
                    }

                    //mkFolder = Path.GetFullPath("file/response/");
                    mkFolder = Path.GetFullPath("file/response/custrpt/");
                    var dataDummy2 = new JObject();
                    dataDummy2.Add("status", mc.GetMessage("api_output_ok"));
                    dataDummy2.Add("response", strXmlData);
                    jocus_personal = dataDummy2;
                    //end

                    if (jocus_personal.GetValue("status").ToString() == mc.GetMessage("api_output_ok"))
                    {
                        var strRes_cus_company = jocus_personal.GetValue("response").ToString();
                        //strRes_cus_company = strRes_cus_company.Replace("UTF-8", "UTF-8 without BOM");
                        XmlDocument resdocx_cus_company = new XmlDocument();
                        resdocx_cus_company.Load(new StringReader(strRes_cus_company));
                        //save response custom report
                        //folder = Path.GetFullPath("file/response/");
                        folder = Path.GetFullPath("file/response/custrpt/");
                        path = folder + prefix_res + prefix_cus + filenamecust + joHeader.GetValue("ext").ToString();
                        resdocx_cus_company.Save(path);

                        // save to credential server 
                        var fileNamecust1 = prefix_res + prefix_cus + filenamecust + joHeader.GetValue("ext").ToString();
                        var ip = dbconn.GetCredential("urlNetworkCredentialy");
                        var pathserverother = dbconn.GetCredential("pathserverother");
                        var username = dbconn.GetCredential("username");
                        var pass = dbconn.GetCredential("pass");
                        string a = abc.connectToRemote(ip, username, pass);

                        string local = @"" + path + "";
                        string remote = @"" + pathserverother + "custrpt\\" + fileNamecust1 + "";

                        if (System.IO.File.Exists(remote))
                        {
                            System.IO.File.Delete(remote);

                            System.IO.File.Copy(local, remote);
                        }
                        else
                        {
                            System.IO.File.Copy(local, remote);
                        }
                        abc.disconnectRemote(ip);

                        var pathaip = dbconn.GetCredential("pathserverother").ToString() + "custrpt\\" + fileNamecust1;
                        this.Insertfilemapbk("Custom", json.GetValue("ttable").ToString(), json.GetValue("ktp").ToString(), pefindoid, pathaip, count_pefid);
                    }
                    #endregion
                }

                // other data 
                var joother_data = new JObject();
                var strRes_smr_otherdata = "";
                if (jocus_personal.GetValue("status").ToString() == mc.GetMessage("api_output_ok"))
                {
                    strRes_smr_otherdata = jocus_personal.GetValue("response").ToString();

                    XmlDocument resdocx_smr_other = new XmlDocument();
                    resdocx_smr_other.Load(new StringReader(strRes_smr_otherdata));

                    var josmr_other_xml = JsonConvert.SerializeXmlNode(resdocx_smr_other);
                    var joReqotherRpt = JObject.Parse(josmr_other_xml);
                    joReqotherRpt.Add("subject_type", json.GetValue("type_data").ToString());
                    joReqotherRpt.Add("ktp", json.GetValue("ktp").ToString());
                    var joGenReqOtherdata = GenerateReqPersonalOtherData(joReqotherRpt, pefindoid, requestid);

                    filename = joGenReqOtherdata.GetValue("filename").ToString();
                    folder = Path.GetFullPath("file/request/other/");
                    path = folder + prefix_req + "other_" + filename + joHeader.GetValue("ext").ToString();

                    strXmlData = "";
                    using (StreamReader sr = new StreamReader(path))
                    {
                        strXmlData = sr.ReadToEnd();
                    }

                    folder = Path.GetFullPath("file/request/other/");
                    XmlDocument reqdocx_otherdata = new XmlDocument();
                    reqdocx_otherdata.Load(new StringReader(strXmlData));

                    //// start remark untuk proses 2 dummy data dan unremark jika direct langnsung ke pefindo webservice
                    //joother_data = PostDataXml(reqdocx_otherdata, soapaction);
                    //joother_data = PostDataXmlnotsoap(strXmlData);
                    ////end

                    //  start proses 2 ini jika pakai dumm dan remark jika pakai dummy data
                    reqname = joHeader.GetValue("dummy_otd").ToString();
                    //reqname = json.GetValue("ktp").ToString() + reqname;
                    filename = reqname;
                    folder = Path.GetFullPath("file/response/other/");
                    //folder = Path.GetFullPath("file/response/");
                    path = folder + prefix_res + "other_" + filename + joHeader.GetValue("ext").ToString();

                    strXmlData = "";
                    using (StreamReader sr = new StreamReader(path))
                    {
                        strXmlData = sr.ReadToEnd();
                    }

                    //mkFolder = Path.GetFullPath("file/response/");
                    mkFolder = Path.GetFullPath("file/response/other/");

                    var dataDummy3 = new JObject();
                    dataDummy3.Add("status", mc.GetMessage("api_output_ok"));
                    dataDummy3.Add("response", strXmlData);

                    joother_data = dataDummy3;
                    // end 


                    if (joother_data.GetValue("status").ToString() == mc.GetMessage("api_output_ok"))
                    {

                        var strRes_other_data = joother_data.GetValue("response").ToString();

                        XmlDocument resdocx_other_data = new XmlDocument();
                        resdocx_other_data.Load(new StringReader(strRes_other_data));
                        //save response other data
                        //folder = Path.GetFullPath("file/response/");
                        folder = Path.GetFullPath("file/response/other/");

                        var today = DateTime.Now.ToString("yyyyMMddHHmmss");
                        filename_otherdata = json.GetValue("ktp").ToString() + "_" + today;
                        //path = folder + prefix_res + "other_" + filename + joHeader.GetValue("ext").ToString();
                        path = folder + prefix_res + "other_" + filename_otherdata + joHeader.GetValue("ext").ToString();
                        resdocx_other_data.Save(path);

                        // save to credential server 
                        var fileNameother1 = prefix_res + "other_" + filename_otherdata + joHeader.GetValue("ext").ToString();
                        var ip = dbconn.GetCredential("urlNetworkCredentialy");
                        var pathserverother = dbconn.GetCredential("pathserverother");
                        var username = dbconn.GetCredential("username");
                        var pass = dbconn.GetCredential("pass");
                        string a = abc.connectToRemote(ip, username, pass);

                        string local = @"" + path + "";
                        string remote = @"" + pathserverother + "otherdata\\" + fileNameother1 + "";

                        if (System.IO.File.Exists(remote))
                        {
                            System.IO.File.Delete(remote);

                            System.IO.File.Copy(local, remote);
                        }
                        else
                        {
                            System.IO.File.Copy(local, remote);
                        }


                        abc.disconnectRemote(ip);
                        var pathaipother = dbconn.GetCredential("pathserverother").ToString() + "otherdata\\" + fileNameother1;

                        this.Insertfilemapbk("otherdata", json.GetValue("ttable").ToString(), json.GetValue("ktp").ToString(), pefindoid, pathaipother, count_pefid);

                        // end
                    }
                }

                // end


                // pdf rpt
                #region prosess async pdf rpt dan other data parsing
                var joReq = new JObject();
                joReq.Add("pefindoid", pefindoid);
                joReq.Add("joother_data", joother_data.GetValue("status").ToString());
                joReq.Add("response", joother_data.GetValue("response").ToString());
                joReq.Add("requestid", requestid);
                joReq.Add("type_data", json.GetValue("type_data").ToString());
                joReq.Add("ktp", json.GetValue("ktp").ToString());
                joReq.Add("ttable", json.GetValue("ttable").ToString());
                joReq.Add("ext", joHeader.GetValue("ext").ToString());
                //joReq.Add("dummy_pdf", joHeader.GetValue("dummy_pdf").ToString());
                //Processpdfrpt(joReq, count_pefid);

                #endregion

                #region proses convert response xml ke json

                resdate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");

                // proses convert xml ke json
                //folder = Path.GetFullPath("file/response/");
                folder = Path.GetFullPath("file/response/custrpt/");

                //start untuk testing filename disetup sebagai ='1123433_20190805161923' dan jika direct langsung di remark
                //reqname = joHeader.GetValue("dummy_cus").ToString();
                ////reqname = json.GetValue("ktp").ToString() + reqname;
                //filename = reqname;
                //end

                path = folder + prefix_res + prefix_cus + filenamecust + joHeader.GetValue("ext").ToString();

                strXmlData = "";
                using (StreamReader sr = new StreamReader(path))
                {
                    strXmlData = sr.ReadToEnd();
                }

                XmlDocument docx = new XmlDocument();
                docx.Load(new StringReader(strXmlData));
                var joXml = JsonConvert.SerializeXmlNode(docx);
                //mkFolder = Path.GetFullPath("file/response/" + prefix_res + prefix_cus + filename + ".json");
                mkFolder = Path.GetFullPath("file/response/custrpt/" + prefix_res + prefix_cus + filenamecust + ".json");
                FileInfo fi = new FileInfo(mkFolder);

                //check 1st check file jika sudah ada di delete dan generate baru
                if (fi.Exists)
                {
                    fi.Delete();
                }

                // Create a new file     
                //using (FileStream fs = fi.Create())
                //{
                //    Byte[] txt = new UTF8Encoding(true).GetBytes("New file.");
                //    fs.Write(txt, 0, txt.Length);
                //    Byte[] author = new UTF8Encoding(true).GetBytes("idxteam");
                //    fs.Write(author, 0, author.Length);
                //}
                //System.IO.File.WriteAllText(mkFolder, joXml);

                //var joDataXml1 = new JObject();
                //joDataXml1 = JObject.Parse(joXml.ToString());



                System.IO.File.WriteAllText(mkFolder, joXml);

                var joDataXml1 = new JObject();
                joDataXml1 = JObject.Parse(joXml.ToString());
                // end
                #endregion


                #region prosess insert otherdata 

                var module = "urlAPI_idcbkintegration";
                string outApi = "";
                var joReq_reader = new JObject();
                var namefileotherdata = prefix_res + "other_" + filename_otherdata;
                joReq_reader.Add("pefindoid", pefindoid);
                joReq_reader.Add("filename", namefileotherdata);
                JObject credential = tc.GetToken(module);
                outApi = bc.execExtAPIPostWithToken(module, "FileReader/OtherDataReport", joReq_reader.ToString(), "bearer " + credential.GetValue("access_token").ToString());
                var riquestdata = JObject.Parse(outApi);
                #endregion

                data.Add("status", mc.GetMessage("process_success"));
                data.Add("reqdate", joReqData.GetValue("reqdate").ToString());
                data.Add("resdate", resdate);
                data.Add("filename", filenamecust);
                data.Add("data", joDataXml1);
                data.Add("response", strRes_smr_company);
            }
            catch (Exception ex)
            {
                data.Add("status", "invalid");
                data.Add("Message", ex.Message);
            }

            return data;
        }
        #endregion

        public async void Processpdfrpt(JObject json, string count_pefid)
        {
            try
            {
                await Task.Delay(1000);
            }
            finally
            {
                //#region proses pdf rpt
                string strXmlData = "";
                var pefindoid = json.GetValue("pefindoid").ToString();
                var requestid = json.GetValue("requestid").ToString();
                var jopdf_rpt = new JObject();
                var strRes_smr_pdfrpt = "";
                var targetDir = "";
                var pathnew = "";
                var status = json.GetValue("joother_data").ToString();
                if (status == mc.GetMessage("api_output_ok"))
                {
                    strRes_smr_pdfrpt = json.GetValue("response").ToString();


                    XmlDocument resdocx_smr_pdfrpf = new XmlDocument();
                    resdocx_smr_pdfrpf.Load(new StringReader(strRes_smr_pdfrpt));

                    var josmr_pdfrpt_xml = JsonConvert.SerializeXmlNode(resdocx_smr_pdfrpf);
                    var joReqPdfRpt = JObject.Parse(josmr_pdfrpt_xml);
                    joReqPdfRpt.Add("subject_type", json.GetValue("type_data").ToString());
                    joReqPdfRpt.Add("ktp", json.GetValue("ktp").ToString());
                    var joGenReqPdfRpt = GenerateReqPersonalPdfRpt(joReqPdfRpt, pefindoid, requestid);

                    var filename = joGenReqPdfRpt.GetValue("filename").ToString();
                    var folder = Path.GetFullPath("file/request/pdfrpt/");
                    var path = folder + prefix_req + "pdfrpt_" + filename + json.GetValue("ext").ToString();

                    strXmlData = "";
                    using (StreamReader sr = new StreamReader(path))
                    {
                        strXmlData = sr.ReadToEnd();
                    }

                    folder = Path.GetFullPath("file/request/pdfrpt/");
                    XmlDocument reqdocx_pdfrpt = new XmlDocument();
                    reqdocx_pdfrpt.Load(new StringReader(strXmlData));

                    //// start remark untuk proses 2 dummy data dan unremark jika direct langnsung ke pefindo webservice
                    //jopdf_rpt = PostDataXml(reqdocx_pdfrpt, soapaction);
                    jopdf_rpt = PostDataXmlnotsoap(strXmlData);
                    ////end



                    //  start proses 2 ini jika pakai dumm dan remark jika pakai dummy data

                    //var reqname = json.GetValue("dummy_pdf").ToString();
                    ////reqname = json.GetValue("ktp").ToString() + reqname;
                    //filename = reqname;
                    //folder = Path.GetFullPath("file/response/pdfrpt/");
                    //path = folder + prefix_res + "pdfrpt_" + filename + json.GetValue("ext").ToString();

                    //strXmlData = "";
                    //using (StreamReader sr = new StreamReader(path))
                    //{
                    //    strXmlData = sr.ReadToEnd();
                    //}
                    //var mkFolder = Path.GetFullPath("file/response/pdfrpt/");

                    //var dataDummy4 = new JObject();
                    //dataDummy4.Add("status", mc.GetMessage("api_output_ok"));
                    //dataDummy4.Add("response", strXmlData);
                    //jopdf_rpt = dataDummy4;
                    // end 

                    var filename_pdfrpt = "";
                    if (jopdf_rpt.GetValue("status").ToString() == mc.GetMessage("api_output_ok"))
                    {

                        try
                        {
                            var strRes_pdfrpt_data = jopdf_rpt.GetValue("response").ToString();
                          
                            var rtndata = new JObject();
                            var rtndata1 = new JObject();
                            XmlDocument doc = new XmlDocument();
                            doc.Load(new StringReader(strRes_pdfrpt_data));
                            string jsonText = JsonConvert.SerializeXmlNode(doc);
                            rtndata = JObject.Parse(jsonText);
                            var today = DateTime.Now.ToString("yyyyMMddHHmmss");
                            filename_pdfrpt = json.GetValue("ktp").ToString() + "_" + today;
                            //folder = Path.GetFullPath("file/response/");
                            folder = Path.GetFullPath("file/response/pdfrpt/");
                            var pathpdf = folder + prefix_res + "pdfrpt_" + filename_pdfrpt + ".zip";

                            var value = JObject.Parse((JObject.Parse((JObject.Parse(rtndata["ns0:ServiceEnvelope"].ToString()))["ns1:ServiceBody"].ToString()))["ns2:pfGetPdfReportRs"].ToString());
                            var code = value.GetValue("ns2:GetPdfReportResult").ToString();

                        

                            string base64BinaryStr = code;
                            byte[] sPDFDecoded = Convert.FromBase64String(base64BinaryStr);

                            System.IO.File.WriteAllBytes(pathpdf, sPDFDecoded);


                            FastZip fastZip = new FastZip();
                            string fileFilter = null;
                            targetDir = folder + prefix_res + "pdfrpt_" + filename_pdfrpt;
                            // Will always overwrite if target filenames already exist
                            fastZip.ExtractZip(pathpdf, targetDir, fileFilter);

                            // Create a FileInfo  
                            System.IO.FileInfo fi = new System.IO.FileInfo(targetDir + "//" + "report.pdf");
                            // Check if file is there  
                            if (fi.Exists)
                            {
                                var renamepdf = targetDir +"//" +prefix_res + "pdfrpt_" + filename_pdfrpt + ".pdf";
                                pathnew = renamepdf;
                                // Move file with a new name. Hence renamed.  
                                fi.MoveTo(renamepdf);
                               
                            }

                        }
                        catch (Exception e)
                        {
                            string filename8 = Path.GetFullPath("file/catch/catch.txt");
                            if (System.IO.File.Exists(filename8))
                            {
                                using (StreamWriter sw = System.IO.File.AppendText(filename8))
                                {
                                    sw.WriteLine(DateTime.Now);
                                    sw.WriteLine(e.Message);
                                    sw.Close();
                                }
                            }


                            Console.WriteLine(e.ToString());

                        }



                        // save to credential server 

                        var fileNamepdf1 = prefix_res + "pdfrpt_" + filename_pdfrpt + ".pdf";
                        var ip = dbconn.GetCredential("urlNetworkCredentialy");
                        var pathserverother = dbconn.GetCredential("pathserverother");
                        var username = dbconn.GetCredential("username");
                        var pass = dbconn.GetCredential("pass");
                        string a = abc.connectToRemote(ip, username, pass);

                        string local = @"" + pathnew + "";
                        string remote = @"" + pathserverother + "pdfrpt\\" + fileNamepdf1 + "";

                        if (System.IO.File.Exists(remote))
                        {

                            System.IO.File.Delete(remote);

                            System.IO.File.Copy(local, remote);



                        }
                        else
                        {

                            System.IO.File.Copy(local, remote);

                        }
                        abc.disconnectRemote(ip);
                        var pathaippdf = dbconn.GetCredential("pathserverother").ToString() + "pdfrpt\\" + fileNamepdf1;
                        this.Insertfilemapbk("pdf", json.GetValue("ttable").ToString(), json.GetValue("ktp").ToString(), pefindoid, pathaippdf, count_pefid);

                        // end

                    }
                }

            }

        }

       
        public JObject GenerateReqPersonalData(JObject json, string requestid)
        {
            var data = new JObject();
            var joRtnInfo = new JObject();
            var today = DateTime.Now.ToString("yyyyMMddHHmmss");
            var reqdate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            var RqTimestamp = DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss.fff");
            string allText = "";

            using (StreamReader sr = new StreamReader("file/headerconfig.json"))
            {
                allText = sr.ReadToEnd();
            }
            var joHeader = JObject.Parse(allText);
            var joData = json;
            var doc = new XmlDocument();
            
            #region generate req xml
            XNamespace ns0 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceEnvelope";
            XNamespace ns1 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceHeader";
            XNamespace ns4 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceBody";
            XNamespace ns2 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/BSMF/pfSmartSearchIndividual/01";
            XNamespace ns3 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/BSMF/CTCBCore/01";

            XElement root = new XElement(ns0 + "ServiceEnvelope", new XAttribute(XNamespace.Xmlns + "ns0", ns0.NamespaceName),
                new XElement(ns1 + "ServiceHeader", new XAttribute(XNamespace.Xmlns + "ns1", ns1.NamespaceName),
                            new XElement(ns1 + "StandardType", joHeader.GetValue("StandardType").ToString()),
                            new XElement(ns1 + "StandardVersion", joHeader.GetValue("StandardVersion").ToString()),
                            new XElement(ns1 + "ServiceName", joHeader.GetValue("ServiceName").ToString()),
                            new XElement(ns1 + "ServiceVersion", joHeader.GetValue("ServiceVersion").ToString()),
                            new XElement(ns1 + "SourceID", joHeader.GetValue("SourceID").ToString()),
                            new XElement(ns1 + "ChannelID", joHeader.GetValue("ChannelID").ToString()),
                            new XElement(ns1 + "TransactionID", joHeader.GetValue("TransactionID").ToString() + requestid),
                            new XElement(ns1 + "RqTimestamp", RqTimestamp)


                    ),
                new XElement(ns4 + "ServiceBody", new XAttribute(XNamespace.Xmlns + "ns1", ns4.NamespaceName),
                             new XElement(ns2 + "pfSmartSearchIndividualRq",
                                  new XAttribute(XNamespace.Xmlns + "ns2", ns2.NamespaceName),
                                  new XAttribute(XNamespace.Xmlns + "ns3", ns3.NamespaceName),
                                          new XElement(ns3 + "TxnCode", joHeader.GetValue("TxnCode").ToString()),
                                          new XElement(ns3 + "RqUID", joHeader.GetValue("RqUID").ToString() + requestid),
                                          new XElement(ns3 + "query",
                                                       new XElement(ns3 + "InquiryReason", joHeader.GetValue("InquiryReason").ToString()),
                                                       new XElement(ns3 + "InquiryReasonText"),
                                                       new XElement(ns3 + "Parameters",
                                                                    new XElement(ns3 + "DateOfBirth", json.GetValue("dob").ToString() + "T00:00:00"),
                                                                    new XElement(ns3 + "FullName", json.GetValue("name").ToString()),
                                                                    new XElement(ns3 + "IdNumbers",
                                                                                 new XElement(ns3 + "IdNumberPairIndividual",
                                                                                              new XElement(ns3 + "IdNumber", json.GetValue("ktp").ToString()),
                                                                                              new XElement(ns3 + "IdNumberType", "KTP")
                                                                                              )
                                                                                 )

                                                                     )
                                                       )
                                           )
                             )
                );
            #endregion 

            var filename = "";
            //var folder = Path.GetFullPath("file/request/");
            var folder = Path.GetFullPath("file/request/smrserch/");
            filename = joData.GetValue("ktp").ToString() + "_" + today;
            var path = folder + prefix_req + prefix_smr + filename + joHeader.GetValue("ext").ToString();

            root.Save(path);

            data.Add("filename", filename);
            data.Add("reqdate", reqdate);

            return data;
        }

        public JObject GenerateReqPersonalCustomReport(JObject json, string pefindoid, string requestid)
        {
           

            var data = new JObject();
            var joRtnInfo = new JObject();
            var today = DateTime.Now.ToString("yyyyMMddHHmmss");
            var reqdate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            var reqdate_cusrpt = DateTime.Now.ToString("yyyy-MM-dd");
            var RqTimestamp = DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss.fff");
            string allText = "";

            using (StreamReader sr = new StreamReader("file/headerconfig.json"))
            {
                allText = sr.ReadToEnd();
            }
            var joHeader = JObject.Parse(allText);
            var joData = json;
            var doc = new XmlDocument();

            #region generate req xml
            

            XNamespace ns0 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceEnvelope";
            XNamespace ns1 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceHeader";
            XNamespace ns2 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/BSMF/pfGetCustomReport/01";
            XNamespace ns4 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceBody";
            XNamespace ns3 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/BSMF/CTCBCore/01";
                    

            XElement root = new XElement(ns0 + "ServiceEnvelope", new XAttribute(XNamespace.Xmlns + "ns0", ns0.NamespaceName),
                new XElement(ns1 + "ServiceHeader", new XAttribute(XNamespace.Xmlns + "ns1", ns1.NamespaceName),
                            new XElement(ns1 + "StandardType", joHeader.GetValue("StandardType_cri").ToString()),
                            new XElement(ns1 + "StandardVersion", joHeader.GetValue("StandardVersion_cri").ToString()),
                            new XElement(ns1 + "ServiceName", joHeader.GetValue("ServiceName_cri").ToString()),
                            new XElement(ns1 + "ServiceVersion", joHeader.GetValue("ServiceVersion_cri").ToString()),
                            new XElement(ns1 + "SourceID", joHeader.GetValue("SourceID_cri").ToString()),
                            new XElement(ns1 + "ChannelID", joHeader.GetValue("ChannelID_cri").ToString()),
                            new XElement(ns1 + "TransactionID", joHeader.GetValue("TransactionID_cri").ToString() + requestid),
                            new XElement(ns1 + "RqTimestamp", RqTimestamp)


                    ),
                new XElement(ns4 + "ServiceBody", new XAttribute(XNamespace.Xmlns + "ns1", ns4.NamespaceName),
                             new XElement(ns2 + "pfGetCustomReportRq",
                                  new XAttribute(XNamespace.Xmlns + "ns2", ns2.NamespaceName),
                                  new XAttribute(XNamespace.Xmlns + "ns3", ns3.NamespaceName),
                                          new XElement(ns3 + "TxnCode", joHeader.GetValue("TxnCode_cri").ToString()),
                                          new XElement(ns3 + "RqUID", joHeader.GetValue("RqUID_cri").ToString() + requestid),
                                          new XElement(ns3 + "parameters",
                                                       new XElement(ns3 + "Consent", Convert.ToBoolean(joHeader.GetValue("Consent").ToString())),
                                                       new XElement(ns3 + "IDNumber", pefindoid),
                                                       new XElement(ns3 + "IDNumberType", joHeader.GetValue("IDNumberType").ToString()),
                                                       new XElement(ns3 + "InquiryReason", joHeader.GetValue("InquiryReason").ToString()),
                                                       new XElement(ns3 + "InquiryReasonText"),
                                                       new XElement(ns3 + "ReportDate", reqdate_cusrpt),
                                                       new XElement(ns3 + "Sections",
                                                                    new XElement(ns3 + "string", joHeader.GetValue("Sections").ToString())
                                                                    ),
                                                       new XElement(ns3 + "SubjectType", joData.GetValue("subject_type").ToString())
                                                     )
                                       
                                                     
                                           )
                             )
                );


            #endregion 

            var filename_custrpt = "";
            var folder = Path.GetFullPath("file/request/custrpt/");

            filename_custrpt = joData.GetValue("ktp").ToString() + "_" + today;
            var path = folder + prefix_req + prefix_cus + filename_custrpt + joHeader.GetValue("ext").ToString();
            
            root.Save(path);

            data.Add("filename", filename_custrpt);
            data.Add("reqdate", reqdate);

            return data;
        }

        public JObject GenerateReqPersonalOtherData(JObject json, string pefindoid, string requestid)
        {
           
            var data = new JObject();
            var joRtnInfo = new JObject();
            var today = DateTime.Now.ToString("yyyyMMddHHmmss");
            var reqdate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            var reqdate_cusrpt = DateTime.Now.ToString("yyyy-MM-dd");
            var RqTimestamp = DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss.fff");
            string allText = "";

            using (StreamReader sr = new StreamReader("file/headerconfig.json"))
            {
                allText = sr.ReadToEnd();
            }
            var joHeader = JObject.Parse(allText);
            var joData = json;
            var doc = new XmlDocument();

            #region generate req xml


            XNamespace ns0 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceEnvelope";
            XNamespace ns1 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceHeader";
            XNamespace ns2 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/BSMF/pfOTGetReport/01";
            XNamespace ns3 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/BSMF/CTCBCore/01";
            XNamespace ns4 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceBody";


            XElement root = new XElement(ns0 + "ServiceEnvelope", new XAttribute(XNamespace.Xmlns + "ns0", ns0.NamespaceName),
                new XElement(ns1 + "ServiceHeader", new XAttribute(XNamespace.Xmlns + "ns1", ns1.NamespaceName),
                            new XElement(ns1 + "StandardType", joHeader.GetValue("StandardType_otd").ToString()),
                            new XElement(ns1 + "StandardVersion", joHeader.GetValue("StandardVersion_otd").ToString()),
                            new XElement(ns1 + "ServiceName", joHeader.GetValue("ServiceName_otd").ToString()),
                            new XElement(ns1 + "ServiceVersion", joHeader.GetValue("ServiceVersion_otd").ToString()),
                            new XElement(ns1 + "SourceID", joHeader.GetValue("SourceID_otd").ToString()),
                            new XElement(ns1 + "ChannelID", joHeader.GetValue("ChannelID_otd").ToString()),
                            new XElement(ns1 + "TransactionID", joHeader.GetValue("TransactionID_otd").ToString() + requestid),
                            new XElement(ns1 + "RqTimestamp", RqTimestamp)


                    ),
                new XElement(ns4 + "ServiceBody", new XAttribute(XNamespace.Xmlns + "ns1", ns4.NamespaceName),
                             new XElement(ns2 + "pfOTGetReportRq",
                                  new XAttribute(XNamespace.Xmlns + "ns2", ns2.NamespaceName),
                                  new XAttribute(XNamespace.Xmlns + "ns3", ns3.NamespaceName),
                                          new XElement(ns3 + "TxnCode", joHeader.GetValue("TxnCode_otd").ToString()),
                                          new XElement(ns3 + "RqUID", joHeader.GetValue("RqUID_otd").ToString() + requestid),
                                          new XElement(ns3 + "parameters",
                                                       new XElement(ns3 + "PefindoId", pefindoid),
                                                       new XElement(ns3 + "InquiryReason", joHeader.GetValue("InquiryReason_otd").ToString()),
                                                       new XElement(ns3 + "InquiryReasonText"),
                                                       new XElement(ns3 + "SubjectType", joHeader.GetValue("SubjectType_otd").ToString())
                                                     )


                                           )
                             )
                );


            #endregion 

            var filename_otherdata = "";
            var folder = Path.GetFullPath("file/request/other/");

            filename_otherdata = joData.GetValue("ktp").ToString() + "_" + today;
            var path = folder + prefix_req + "other_" + filename_otherdata + joHeader.GetValue("ext").ToString();

            root.Save(path);

            data.Add("filename", filename_otherdata);
            data.Add("reqdate", reqdate);

            return data;
        }


        public JObject GenerateReqPersonalPdfRpt(JObject json, string pefindoid, string requestid)
        {

            var data = new JObject();
            var joRtnInfo = new JObject();
            var today = DateTime.Now.ToString("yyyyMMddHHmmss");
            var reqdate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            var reqdate_cusrpt = DateTime.Now.ToString("yyyy-MM-dd");
            var RqTimestamp = DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss.fff");
            string allText = "";

            using (StreamReader sr = new StreamReader("file/headerconfig.json"))
            {
                allText = sr.ReadToEnd();
            }
            var joHeader = JObject.Parse(allText);
            var joData = json;
            var doc = new XmlDocument();

            #region generate req xml


            XNamespace ns0 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceEnvelope";
            XNamespace ns1 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceHeader";
            XNamespace ns2 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/BSMF/pfGetPdfReport/01";
            XNamespace ns3 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/BSMF/CTCBCore/01";
            XNamespace ns4 = "http://ns.chinatrust.com.tw/XSD/CTCB/ESB/Message/EMF/ServiceBody";


            XElement root = new XElement(ns0 + "ServiceEnvelope", new XAttribute(XNamespace.Xmlns + "ns0", ns0.NamespaceName),
                new XElement(ns1 + "ServiceHeader", new XAttribute(XNamespace.Xmlns + "ns1", ns1.NamespaceName),
                            new XElement(ns1 + "StandardType", joHeader.GetValue("StandardType_pdf").ToString()),
                            new XElement(ns1 + "StandardVersion", joHeader.GetValue("StandardVersion_pdf").ToString()),
                            new XElement(ns1 + "ServiceName", joHeader.GetValue("ServiceName_pdf").ToString()),
                            new XElement(ns1 + "ServiceVersion", joHeader.GetValue("ServiceVersion_pdf").ToString()),
                            new XElement(ns1 + "SourceID", joHeader.GetValue("SourceID_pdf").ToString()),
                            new XElement(ns1 + "ChannelID", joHeader.GetValue("ChannelID_pdf").ToString()),
                            new XElement(ns1 + "TransactionID", joHeader.GetValue("TransactionID_pdf").ToString() + requestid),
                            new XElement(ns1 + "RqTimestamp", RqTimestamp)


                    ),
                new XElement(ns4 + "ServiceBody", new XAttribute(XNamespace.Xmlns + "ns1", ns4.NamespaceName),
                             new XElement(ns2 + "pfGetPdfReportRq",
                                  new XAttribute(XNamespace.Xmlns + "ns2", ns2.NamespaceName),
                                  new XAttribute(XNamespace.Xmlns + "ns3", ns3.NamespaceName),
                                          new XElement(ns3 + "TxnCode", joHeader.GetValue("TxnCode_pdf").ToString()),
                                          new XElement(ns3 + "RqUID", joHeader.GetValue("RqUID_pdf").ToString() + requestid),
                                          new XElement(ns3 + "parameters",
                                                       new XElement(ns3 + "Consent", Convert.ToBoolean(joHeader.GetValue("Consent_pdf").ToString())),
                                                       new XElement(ns3 + "IDNumber", pefindoid),
                                                       new XElement(ns3 + "IDNumberType", joHeader.GetValue("IDNumberType_pdf").ToString()),
                                                       new XElement(ns3 + "InquiryReason", joHeader.GetValue("InquiryReason_pdf").ToString()),
                                                       new XElement(ns3 + "InquiryReasonText"),
                                                       new XElement(ns3 + "LanguageCode", joHeader.GetValue("LanguageCode_pdf").ToString()),
                                                       new XElement(ns3 + "ReportName", joHeader.GetValue("ReportName_pdf").ToString()),
                                                       new XElement(ns3 + "SubjectType", joHeader.GetValue("SubjectType_pdf").ToString())
                                                     )


                                           )
                             )
                );


            #endregion 

            var filename_pdfrpt = "";
            var folder = Path.GetFullPath("file/request/pdfrpt/");

            filename_pdfrpt = joData.GetValue("ktp").ToString() + "_" + today;
            var path = folder + prefix_req + "pdfrpt_" + filename_pdfrpt + joHeader.GetValue("ext").ToString();

            root.Save(path);

            data.Add("filename", filename_pdfrpt);
            data.Add("reqdate", reqdate);

            return data;
        }


  

        #region global function
        public JObject PostDataXml([FromBody]XmlDocument xml, string soapaction)
        {
            var data = new JObject();
            var url = dbconn.domainGetApi("urlWS_pefindo");
            var handlesleep = Convert.ToInt32(dbconn.GetCredential("handle_sleep"));
            var credential = dbconn.GetCredential("Creadential_pefindo");
            var content_type = dbconn.GetCredential("Content_Type"); ;
            string outApi = "";
            byte[] restByte = { };
            XmlDocument docx = new XmlDocument();
            try
            {
                var client = new HttpClient();

                var _url = url;
                var _action = dbconn.domainGetApi(soapaction);
                XmlDocument soapEnvelopeXml = xml;
                HttpWebRequest webRequest = CreateWebRequest(_url, _action, credential);
                InsertSoapEnvelopeIntoWebRequest(soapEnvelopeXml, webRequest);

                // begin async call to web request.
                IAsyncResult asyncResult = webRequest.BeginGetResponse(null, null);

                Task<int> task = HandleSleepAsync(handlesleep);
                task.Wait();
                var x = task.Result;

                // suspend this thread until call is complete. You might want to
                // do something usefull here like update your UI.
                asyncResult.AsyncWaitHandle.WaitOne();

                // get the response from the completed web request.
                string soapResult;
                using (WebResponse webResponse = webRequest.EndGetResponse(asyncResult))
                {
                    using (StreamReader rd = new StreamReader(webResponse.GetResponseStream()))
                    {
                        soapResult = rd.ReadToEnd();
                    }
                }

                data = new JObject();
                data.Add("status", mc.GetMessage("api_output_ok"));
                data.Add("response", soapResult);

            }
            catch (Exception ex)
            {
                data = new JObject();
                data.Add("status", mc.GetMessage("api_output_not_ok"));
                outApi = ex.Message.ToString() + ". Url ==> " + url + " . Content type ==> " + content_type + ", username & pwd : " + credential;

                string filename = Path.GetFullPath("file/catch/catch.txt");  
                if (System.IO.File.Exists(filename))
                {
                    using (StreamWriter sw = System.IO.File.AppendText(filename))
                    {
                        sw.WriteLine(DateTime.Now);
                        sw.WriteLine(outApi);
                        sw.Close();
                    }
                }

                //XmlDocument resdocx_cus_company = new XmlDocument();
                //resdocx_cus_company.Load(new StringReader(outApi));
                ////save response custom report
                //var folder = Path.GetFullPath("file/catch/");
                //var path = folder + "catch.txt";
                //resdocx_cus_company.Save(path);


                data.Add("response", outApi);
            }


            return data;
        }



        //public string execExtAPIPostXML(string api, string xmlstr)
        //{
        //    var WebAPIURL = dbconn.domainGetApi(api);
        //    string requestStr = WebAPIURL;

        //    var client = new HttpClient();
        //    var contentData = new StringContent(xmlstr, System.Text.Encoding.UTF8, "text/xml");

        //    HttpResponseMessage response = client.PostAsync(requestStr, contentData).Result;
        //    string result = response.Content.ReadAsStringAsync().Result;
        //    return result;
        //}

        public JObject PostDataXmlnotsoap(string xmlreq)
        {
            var data = new JObject();
            var url = dbconn.domainGetApi("urlWS_pefindo");
            string outApi = "";


            try
            {

                var WebAPIURL = dbconn.domainGetApi("urlWS_pefindo");
                string requestStr = WebAPIURL;

                var client = new HttpClient();
                var contentData = new StringContent(xmlreq, System.Text.Encoding.UTF8, "text/xml");

                HttpResponseMessage response = client.PostAsync(requestStr, contentData).Result;

                string result = response.Content.ReadAsStringAsync().Result;



                data = new JObject();
                data.Add("status", mc.GetMessage("api_output_ok"));
                data.Add("response", result);


            }
            catch (Exception ex)
            {
                data = new JObject();
                data.Add("status", mc.GetMessage("api_output_not_ok"));
                outApi = ex.Message.ToString() + ". Url ==> " + url;

                string filename = Path.GetFullPath("file/catch/catch.txt");
                if (System.IO.File.Exists(filename))
                {
                    using (StreamWriter sw = System.IO.File.AppendText(filename))
                    {
                        sw.WriteLine(DateTime.Now);
                        sw.WriteLine(outApi);
                        sw.Close();
                    }
                }

                //XmlDocument resdocx_cus_company = new XmlDocument();
                //resdocx_cus_company.Load(new StringReader(outApi));
                ////save response custom report
                //var folder = Path.GetFullPath("file/catch/");
                //var path = folder + "catch.txt";
                //resdocx_cus_company.Save(path);


                data.Add("response", outApi);
            }


            return data;
        }



        private static HttpWebRequest CreateWebRequest(string url, string action, string credential)
        {
            byte[] credentialBuffer = new UTF8Encoding().GetBytes(credential);
            HttpWebRequest webRequest = (HttpWebRequest)WebRequest.Create(url);
            webRequest.Headers.Add("Authorization", "Basic " + Convert.ToBase64String(credentialBuffer));
            webRequest.Headers.Add("SOapAction", action);
            webRequest.ContentType = "text/xml;charset=\"utf-8\"";
            webRequest.Accept = "text/xml";
            webRequest.Method = "POST";
            return webRequest;
        }

        private static HttpWebRequest CreateWebRequestnotsoap(string url)
        {
            //byte[] credentialBuffer = new UTF8Encoding().GetBytes(credential);
            HttpWebRequest webRequest = (HttpWebRequest)WebRequest.Create(url);
            //webRequest.Headers.Add("Authorization", "Basic " + Convert.ToBase64String(credentialBuffer));
            //webRequest.Headers.Add("SOapAction", action);
            webRequest.ContentType = "text/xml;charset=\"utf-8\"";
            webRequest.Accept = "text/xml";
            webRequest.Method = "POST";
            return webRequest;
        }

        private static void InsertSoapEnvelopeIntoWebRequest(XmlDocument soapEnvelopeXml, HttpWebRequest webRequest)
        {
            using (Stream stream = webRequest.GetRequestStream())
            {
                soapEnvelopeXml.Save(stream);
            }
        }

        static async Task<int> HandleSleepAsync(int hdlsleep)
        {
            System.Threading.Thread.Sleep(hdlsleep);
            return 1;
        }

        public void Insertfilemapbk(string rptname, string ttable, string ktp, string pefindoid, string paths, string count_pefid)
        {
            var jaReturn = new JArray();
            var provider = dbconn.sqlprovider();
            var cstrname = dbconn.constringName("idcbk");
            var split = "|";

            string spname = "pfd_insert_filemap";
            string p1 = "@rptname" + split + rptname.ToLower() + split + "s";
            string p2 = "@ttable" + split + ttable + split + "s";
            string p3 = "@ktp" + split + ktp + split + "s";
            string p4 = "@pefindoid" + split + pefindoid + split + "s";
            string p5 = "@path" + split + paths + split + "s";
            string p6 = "@countpefid" + split + count_pefid + split + "s";

            bc.ExecSqlWithoutReturnCustomSplit(provider, cstrname, split, spname, p1, p2, p3, p4, p5, p6);
        }


        public JObject chkjarowinkler(string ktp, string fullnama, string dob, string address, string ttable)
        {
            var jaReturn = new JArray();
            var joReturn = new JObject();
            var provider = dbconn.sqlprovider();
            var cstrname = dbconn.constringName("idcen");
            var split = "||";
            var schema = "workflow";

            string spname = "chkSimilarity";
            string p1 = "@ktp" + split + ktp + split + "s";
            string p2 = "@fullname" + split + fullnama + split + "s";
            string p3 = "@dateofbirth" + split + dob + split + "s";
            string p4 = "@address" + split + address + split + "s";
            string p5 = "@ttable" + split + ttable + split + "s";

            var retObject = new List<dynamic>();
            retObject =  bc.ExecSqlWithReturnCustomSplit(provider, cstrname, split, schema, spname, p1, p2, p3, p4, p5);
            jaReturn = lc.convertDynamicToJArray(retObject);
            if (jaReturn.Count > 0)
            {
                joReturn = JObject.Parse(jaReturn[0].ToString());
            }

            return joReturn;

        }


        public void updatecounterpefid(string ttable)
        {
            var jaReturn = new JArray();
            var provider = dbconn.sqlprovider();
            var cstrname = dbconn.constringName("idcen");
            var split = "|";

            string spname = "update_counter_pefid";
            string p1 = "@ttable" + split + ttable + split + "s";
            bc.ExecSqlWithoutReturnCustomSplit(provider, cstrname, split, spname, p1);
        }

        private JObject CheckDataObject(string rawdata)
        {
            var data = new JObject();
            try
            {
                var jToken = JToken.Parse(rawdata);
                if (jToken is JObject)
                {
                    data.Add("object_type", "JObject");
                }
                else if (jToken is JArray)
                {
                    data.Add("object_type", "JArray");
                }
                else
                {
                    data.Add("object_type", "String");
                }
            }
            catch (Exception ex)
            {
                data.Add("object_type", "String");
            }

            return data;
        }


        #endregion
    }
}

